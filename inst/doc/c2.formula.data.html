<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>2. Data management, model description and testing</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">2. Data management, model description and testing</h1>



<p>The formula-data interface is a critical advantage of the <code>R</code> software. It provides a practical way to describe the model to be estimated and to store data. However, the usual interface is not flexible enough to deal correctly with random utility models. Therefore, <code>mlogit</code> provides tools to construct richer <code>data.frame</code>s and <code>formula</code>s.</p>
<div id="data-management" class="section level2">
<h2>Data management</h2>
<p><code>mlogit</code> is loaded using:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">library</span>(<span class="st">&quot;mlogit&quot;</span>)</span></code></pre></div>
<p>It comes with several data sets that we’ll use to illustrate the features of the library. Data sets used for multinomial logit estimation concern some individuals, that make one or a sequential choice of one alternative among a set of mutually exclusive alternatives. The determinants of these choices are covariates that can depend on the alternative and the choice situation, only on the alternative or only on the choice situation.</p>
<p>To illustrate this typology of the covariates, consider the case of repeated choice of destinations for vacations by families:</p>
<ul>
<li>the length of the vacation, the season are choice situation specific variables,</li>
<li>income, family size are individual specific variables,</li>
<li>distance to destination, cost are alternative specific variables.</li>
</ul>
<p>The unit of observation is therefore the choice situation, and it is also the individual if there is only one choice situation per individual observed, which is often the case.</p>
<p>Such data have therefore a specific structure that can be characterized by three indexes: the alternative, the choice situation and the individual. These three indexes will be denoted <code>alt</code>, <code>chid</code> and <code>id</code>. Note that the distinction between <code>chid</code> and <code>id</code> is only relevant if we have repeated observations for the same individual.</p>
<p>Data sets can have two different shapes: a <em>wide</em> shape (one row for each choice situation) or a <em>long</em> shape (one row for each alternative and, therefore, as many rows as there are alternatives for each choice situation).</p>
<p><code>mlogit</code> deals with both format. It depends on the <code>dfidx</code> package which takes as first argument a <code>data.frame</code> and returns a <code>dfidx</code> object, which is a <code>data.frame</code> in “long” format with a special data frame column which contains the indexes.</p>
<div id="wide-format" class="section level3">
<h3>Wide format</h3>
<p><code>Train</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> is an example of a <em>wide</em> data set:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">data</span>(<span class="st">&quot;Train&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;mlogit&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>Train<span class="op">$</span>choiceid &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(Train)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="kw">head</span>(Train, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   id choiceid choice price_A time_A change_A comfort_A price_B
## 1  1        1      A    2400    150        0         1    4000
## 2  1        2      A    2400    150        0         1    3200
## 3  1        3      A    2400    115        0         1    4000
##   time_B change_B comfort_B
## 1    150        0         1
## 2    130        0         1
## 3    115        0         0</code></pre>
<p>This data set contains data about a stated preference survey in Netherlands. Each individual has responded to several (up to 16) scenarios. For every scenario, two train trips are proposed to the user, with different combinations of four attributes: <code>price</code> (the price in cents of guilders), <code>time</code> (travel time in minutes), <code>change</code> (the number of changes) and <code>comfort</code> (the class of comfort, 0, 1 or 2, 0 being the most comfortable class).</p>
<p>This “wide” format is suitable to store choice situation (or individual specific) variables because, in this case, they are stored only once in the data. Otherwise, it is cumbersome for alternative specific variables because there are as many columns for such variables that there are alternatives.</p>
<p>For such a wide data set, the <code>shape</code> argument of <code>dfidx</code> is mandatory, as its default value is <code>&quot;long&quot;</code>. The alternative specific variables are indicated with the <code>varying</code> argument which is a numeric vector that indicates their position in the data frame. This argument is then passed to <code>stats::reshape</code> that coerced the original <code>data.frame</code> in “long” format. Further arguments may be passed to <code>reshape</code>. For example, as the names of the variables are of the form <code>price_A</code>, one must add <code>sep = &quot;_&quot;</code> (the default value being <code>&quot;.&quot;</code>). The <code>choice</code> argument is also mandatory because the response has to be transformed in a logical value in the long format. To take the panel dimension into account, one has to add an argument <code>id.var</code> which is the name of the individual index.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>Tr &lt;-<span class="st"> </span><span class="kw">dfidx</span>(Train, <span class="dt">shape =</span> <span class="st">&quot;wide&quot;</span>, <span class="dt">varying =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">11</span>, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>            <span class="dt">idx =</span> <span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;choiceid&quot;</span>, <span class="st">&quot;id&quot;</span>)), <span class="dt">idnames =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;alt&quot;</span>))</span></code></pre></div>
<p>Note the use of the <code>opposite</code> argument for the 4 covariates: we expect negative coefficients for all of them, taking the opposite of the covariates will lead to expected positive coefficients. We next convert <code>price</code> and <code>time</code> in more meaningful unities, hours and euros (1 guilder was <span class="math inline">\(2.20371\)</span> euros):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>Tr<span class="op">$</span>price &lt;-<span class="st"> </span>Tr<span class="op">$</span>price <span class="op">/</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="fl">2.20371</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>Tr<span class="op">$</span>time &lt;-<span class="st"> </span>Tr<span class="op">$</span>time <span class="op">/</span><span class="st"> </span><span class="dv">60</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">head</span>(Tr, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## ~~~~~~~
##  first 3 observations out of 5858 
## ~~~~~~~
##   choice    price time change comfort idx
## 1      A 52.88904  2.5      0       1 1:A
## 2      A 88.14840  2.5      0       1 1:B
## 3      A 52.88904  2.5      0       1 2:A
## 
## ~~~ indexes ~~~~
##   choiceid id alt
## 1        1  1   A
## 2        1  1   B
## 3        2  1   A
## indexes:  1, 1, 2</code></pre>
<p>An <code>idx</code> column is added to the data, which contains the three relevant indexes: <code>choiceid</code> is the choice situation index, <code>alt</code> the alternative index and <code>id</code> is the individual index. This column can be extracted using the <code>idx</code> funtion:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">head</span>(<span class="kw">idx</span>(Tr), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## ~~~ indexes ~~~~
##   choiceid id alt
## 1        1  1   A
## 2        1  1   B
## 3        2  1   A
## indexes:  1, 1, 2</code></pre>
</div>
<div id="long-format" class="section level3">
<h3>Long format</h3>
<p><code>ModeCanada</code>,<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> is an example of a data set in long format. It presents the choice of individuals for a transport mode for the Ontario-Quebec corridor:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">data</span>(<span class="st">&quot;ModeCanada&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;mlogit&quot;</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">head</span>(ModeCanada)</span></code></pre></div>
<pre><code>##   case   alt choice dist  cost ivt ovt freq income urban noalt
## 1    1 train      0   83 28.25  50  66    4     45     0     2
## 2    1   car      1   83 15.77  61   0    0     45     0     2
## 3    2 train      0   83 28.25  50  66    4     25     0     2
## 4    2   car      1   83 15.77  61   0    0     25     0     2
## 5    3 train      0   83 28.25  50  66    4     70     0     2
## 6    3   car      1   83 15.77  61   0    0     70     0     2</code></pre>
<p>There are four transport modes (<code>air</code>, <code>train</code>, <code>bus</code> and <code>car</code>) and most of the variable are alternative specific (<code>cost</code> for monetary cost, <code>ivt</code> for in vehicle time, <code>ovt</code> for out of vehicle time, <code>freq</code> for frequency). The only choice situation specific variables are <code>dist</code> (the distance of the trip), <code>income</code> (household income), <code>urban</code> (a dummy for trips which have a large city at the origin or the destination) and <code>noalt</code> the number of available alternatives. The advantage of this shape is that there are much fewer columns than in the wide format, the caveat being that values of <code>dist</code>, <code>income</code> and <code>urban</code> are repeated four times.</p>
<p>For data in “long” format, the <code>shape</code> and the <code>choice</code> arguments are no more mandatory.</p>
<p>To replicate published results later in the text, we’ll use only a subset of the choice situations, namely those for which the 4 alternatives are available. This can be done using the <code>subset</code> function with the <code>subset</code> argument set to <code>noalt == 4</code> while estimating the model. This can also be done within <code>dfidx</code>, using the <code>subset</code> argument.</p>
<p>The information about the structure of the data can be explicitly indicated using choice situations and alternative indexes (respectively <code>case</code> and <code>alt</code> in this data set) or, in part, guessed by the <code>dfidx</code> function. Here, after subsetting, we have 2779 choice situations with 4 alternatives, and the rows are ordered first by choice situation and then by alternative (<code>train</code>, <code>air</code>, <code>bus</code> and <code>car</code> in this order).</p>
<p>The first way to read correctly this data frame is to ignore completely the two index variables. In this case, the only supplementary argument to provide is the <code>alt.levels</code> argument which is a character vector that contains the name of the alternatives in their order of appearance:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>            <span class="dt">alt.levels =</span> <span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;air&quot;</span>, <span class="st">&quot;bus&quot;</span>, <span class="st">&quot;car&quot;</span>))</span></code></pre></div>
<p>Note that this can only be used if the data set is “balanced”, which means than the same set of alternatives is available for all choice situations. It is also possible to provide an argument <code>alt.var</code> which indicates the name of the variable that contains the alternatives</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, <span class="dt">idx =</span> <span class="kw">list</span>(<span class="ot">NA</span>, <span class="st">&quot;alt&quot;</span>))</span></code></pre></div>
<p>The name of the variable that contains the information about the choice situations can be indicated using the <code>chid.var</code> argument:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, <span class="dt">idx =</span> <span class="st">&quot;case&quot;</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>            <span class="dt">alt.levels =</span> <span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;air&quot;</span>, <span class="st">&quot;bus&quot;</span>, <span class="st">&quot;car&quot;</span>))</span></code></pre></div>
<p>Both alternative and choice situation variable can also be provided:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, <span class="dt">idx =</span> <span class="kw">c</span>(<span class="st">&quot;case&quot;</span>, <span class="st">&quot;alt&quot;</span>))</span></code></pre></div>
<p>More simply, as the two indexes are stored in the first two columns of the original data frame, the <code>idx</code> argument can be unset:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>)</span></code></pre></div>
<p>and the indexes can be kept as stand alone series if the <code>drop.index</code> argument is set to <code>FALSE</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>MC &lt;-<span class="st"> </span><span class="kw">dfidx</span>(ModeCanada, <span class="dt">subset =</span> noalt <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, <span class="dt">idx =</span> <span class="kw">c</span>(<span class="st">&quot;case&quot;</span>, <span class="st">&quot;alt&quot;</span>),</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>            <span class="dt">drop.index =</span> <span class="ot">FALSE</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="kw">head</span>(MC)</span></code></pre></div>
<pre><code>## ~~~~~~~
##  first 10 observations out of 11116 
## ~~~~~~~
##    case   alt choice dist   cost ivt ovt freq income urban noalt
## 1   109 train      0  377  58.25 215  74    4     45     0     4
## 2   109   air      1  377 142.80  56  85    9     45     0     4
## 3   109   bus      0  377  27.52 301  63    8     45     0     4
## 4   109   car      0  377  71.63 262   0    0     45     0     4
## 5   110 train      0  377  58.25 215  74    4     70     0     4
## 6   110   air      1  377 142.80  56  85    9     70     0     4
## 7   110   bus      0  377  27.52 301  63    8     70     0     4
## 8   110   car      0  377  71.63 262   0    0     70     0     4
## 9   111 train      0  377  58.25 215  74    4     35     0     4
## 10  111   air      1  377 142.80  56  85    9     35     0     4
##         idx
## 1  109:rain
## 2   109:air
## 3   109:bus
## 4   109:car
## 5  110:rain
## 6   110:air
## 7   110:bus
## 8   110:car
## 9  111:rain
## 10  111:air
## 
## ~~~ indexes ~~~~
##    case   alt
## 1   109 train
## 2   109   air
## 3   109   bus
## 4   109   car
## 5   110 train
## 6   110   air
## 7   110   bus
## 8   110   car
## 9   111 train
## 10  111   air
## indexes:  1, 2</code></pre>
</div>
</div>
<div id="model-description" class="section level2">
<h2>Model description</h2>
<p>Standard <code>formula</code>s are not very practical to describe random utility models, as these models may use different sets of covariates. Actually, working with random utility models, one has to consider at most four sets of covariates:</p>
<ol style="list-style-type: decimal">
<li>alternative and choice situation specific covariates <span class="math inline">\(x_{ij}\)</span> with generic coefficients <span class="math inline">\(\beta\)</span> and and alternative specific covariates <span class="math inline">\(t_j\)</span> with a generic coefficient <span class="math inline">\(\nu\)</span>,</li>
<li>choice situation specific covariates <span class="math inline">\(z_i\)</span> with alternative specific coefficients <span class="math inline">\(\gamma_j\)</span>,</li>
<li>alternative and choice situation specific covariates <span class="math inline">\(w_{ij}\)</span> with alternative specific coefficients <span class="math inline">\(\delta_j\)</span>,</li>
<li>choice situation specific covariates <span class="math inline">\(v_i\)</span> that influence the variance of the errors.</li>
</ol>
<p>The first three sets of covariates enter the observable part of the utility which can be written, alternative <span class="math inline">\(j\)</span>:</p>
<p><span class="math display">\[
V_{ij}=\alpha_j + \beta x_{ij} + \nu t_j + \gamma_j z_i + \delta_j w_{ij} .
\]</span></p>
<p>As the absolute value of utility is irrelevant, only utility differences are useful to modelise the choice for one alternative. For two alternatives <span class="math inline">\(j\)</span> and <span class="math inline">\(k\)</span>, we obtain:</p>
<p><span class="math display">\[ V_{ij}-V_{ik}=(\alpha_j-\alpha_k) + \beta (x_{ij}-x_{ik}) +
(\gamma_j-\gamma_k) z_i + (\delta_j w_{ij} - \delta_k w_{ik}) +
\nu(t_j - t_k).  \]</span></p>
<p>It is clear from the previous expression that coefficients of choice situation specific variables (the intercept being one of those) should be alternative specific, otherwise they would disappear in the differentiation. Moreover, only differences of these coefficients are relevant and can be identified. For example, with three alternatives 1, 2 and 3, the three coefficients <span class="math inline">\(\gamma_1, \gamma_2, \gamma_3\)</span> associated to a choice situation specific variable cannot be identified, but only two linear combinations of them. Therefore, one has to make a choice of normalization and the simplest one is just to set <span class="math inline">\(\gamma_1 = 0\)</span>.</p>
<p>Coefficients for alternative and choice situation specific variables may (or may not) be alternative specific. For example, transport time is alternative specific, but 10 mn in public transport may not have the same impact on utility than 10 mn in a car. In this case, alternative specific coefficients are relevant. Monetary cost is also alternative specific, but in this case, one can consider than 1$ is 1$ whatever it is spent for the use of a car or in public transports. In this case, a generic coefficient is relevant.</p>
<p>The treatment of alternative specific variables don’t differ much from the alternative and choice situation specific variables with a generic coefficient. However, if some of these variables are introduced, the <span class="math inline">\(\nu\)</span> parameter can only be estimated in a model without intercepts to avoid perfect multicolinearity.</p>
<p>Individual-related heteroscedasticity <span class="citation">(see Swait and Louviere 1993)</span> can be addressed by writing the utility of choosing <span class="math inline">\(j\)</span> for individual <span class="math inline">\(i\)</span>: <span class="math inline">\(U_{ij}=V_{ij} + \sigma_i \epsilon_{ij}\)</span>, where <span class="math inline">\(\epsilon\)</span> has a variance that doesn’t depend on <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> and <span class="math inline">\(\sigma_i^2 = f(v_i)\)</span> is a parametric function of some individual-specific covariates. Note that this specification induce choice situation heteroscedasticity, also denoted scale heterogeneity.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. As the overall scale of utility is irrelevant, the utility can also be writen as: <span class="math inline">\(U_{ij}^* = U_{ij} / \sigma_i = V_{ij}/\sigma_i + \epsilon_{ij}\)</span>, i.e., with homoscedastic errors. if <span class="math inline">\(V_{ij}\)</span> is a linear combination of covariates, the associated coefficients are then divided by <span class="math inline">\(\sigma_i\)</span>.</p>
<p>A logit model with only choice situation specific variables is sometimes called a <em>multinomial logit model</em>, one with only alternative specific variables a <em>conditional logit model</em> and one with both kind of variables a <em>mixed logit model</em>. This is seriously misleading: <em>conditional logit model</em> is also a logit model for longitudinal data in the statistical literature and <em>mixed logit</em> is one of the names of a logit model with random parameters. Therefore, in what follows, we’ll use the name <em>multinomial logit model</em> for the model we’ve just described whatever the nature of the explanatory variables used.</p>
<p><code>mlogit</code> package provides objects of class <code>mFormula</code> which are built upon <code>Formula</code> objects provided by the <code>Formula</code> package.<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> The <code>Formula</code> package provides richer <code>formula</code>s, which accept multiple responses (a feature not used here) and multiple set of covariates. It has in particular specific <code>model.frame</code> and <code>model.matrix</code> methods which can be used with one or several sets of covariates.</p>
<p>To illustrate the use of <code>mFormula</code> objects, we use again the <code>ModeCanada</code> data set and consider three sets of covariates that will be indicated in a three-part formula, which refers to the first three items of the four points list at start of this section.</p>
<ul>
<li><code>cost</code> (monetary cost) is an alternative specific covariate with a generic coefficient (part 1),</li>
<li><code>income</code> and <code>urban</code> are choice situation specific covariates (part 2),</li>
<li><code>ivt</code> (in vehicle travel time) is alternative specific and alternative specific coefficients are expected (part 3).</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">library</span>(<span class="st">&quot;Formula&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">|</span><span class="st"> </span>income <span class="op">+</span><span class="st"> </span>urban <span class="op">|</span><span class="st"> </span>ivt)</span></code></pre></div>
<p>Some parts of the formula may be omitted when there is no ambiguity. For example, the following sets of <code>formula</code>s are identical:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>f2 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">+</span><span class="st"> </span>ivt <span class="op">|</span><span class="st"> </span>income <span class="op">+</span><span class="st"> </span>urban)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>f2 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">+</span><span class="st"> </span>ivt <span class="op">|</span><span class="st"> </span>income <span class="op">+</span><span class="st"> </span>urban <span class="op">|</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>f3 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>income <span class="op">|</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>f3 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>income)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>f4 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">+</span><span class="st"> </span>ivt)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>f4 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">+</span><span class="st"> </span>ivt <span class="op">|</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>f4 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">+</span><span class="st"> </span>ivt <span class="op">|</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span><span class="dv">0</span>)</span></code></pre></div>
<p>By default, an intercept is added to the model, it can be removed by using <code>+ 0</code> or <code>- 1</code> in the second part.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a>f5 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">|</span><span class="st"> </span>income <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>ivt)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>f5 &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">|</span><span class="st"> </span>income <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ivt)</span></code></pre></div>
<p><code>model.frame</code> and <code>model.matrix</code> methods are provided for <code>mFormula</code> objects. The latter is of particular interest, as illustrated in the following example:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="kw">Formula</span>(choice <span class="op">~</span><span class="st"> </span>cost <span class="op">|</span><span class="st"> </span>income  <span class="op">|</span><span class="st"> </span>ivt)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>mf &lt;-<span class="st"> </span><span class="kw">model.frame</span>(MC, f)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a><span class="kw">head</span>(<span class="kw">model.matrix</span>(mf), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##   (Intercept)   cost
## 1           1  58.25
## 2           1 142.80
## 3           1  27.52
## 4           1  71.63</code></pre>
<p>The model matrix contains <span class="math inline">\(J-1\)</span> columns for every choice situation specific variables (<code>income</code> and the intercept), which means that the coefficient associated to the first alternative (<code>air</code>) is set to 0. It contains only one column for <code>cost</code> because we want a generic coefficient for this variable. It contains <span class="math inline">\(J\)</span> columns for <code>ivt</code>, because it is an alternative specific variable for which we want alternative specific coefficients.</p>
</div>
<div id="testing" class="section level2">
<h2>Testing</h2>
<p>As for all models estimated by maximum likelihood, three testing procedures may be applied to test hypothesis about models fitted using <code>mlogit</code>. The set of hypothesis tested defines two models: the unconstrained model that doesn’t take these hypothesis into account and the constrained model that impose these hypothesis.</p>
<p>This in turns define three principles of tests: the <em>Wald test</em>, based only on the unconstrained model, the <em>Lagrange multiplier test</em> (or <em>score test</em>), based only on the constrained model and the <em>likelihood ratio test</em>, based on the comparison of both models.</p>
<p>Two of these three tests are implemented in the <code>lmtest</code> package <span class="citation">(Zeileis and Hothorn 2002)</span>: <code>waldtest</code> and <code>lrtest</code>. The Wald test is also implemented as <code>linearHypothesis</code> in package <code>car</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="FOX:WEIS:10"><strong>???</strong></span>)</span>, with a fairly different syntax. We provide special methods of <code>waldtest</code> and <code>lrtest</code> for <code>mlogit</code> objects and we also provide a function for the Lagrange multiplier (or score) test called <code>scoretest</code>.</p>
<p>We’ll see later that the score test is especially useful for <code>mlogit</code> objects when one is interested in extending the basic multinomial logit model because, in this case, the unconstrained model may be difficult to estimate. For the presentation of further tests, we provide a convenient <code>statpval</code> function which extract the statistic and the p-value from the objects returned by the testing function, which can be either of class <code>anova</code> or <code>htest</code>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a>statpval &lt;-<span class="st"> </span><span class="cf">function</span>(x){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="kw">inherits</span>(x, <span class="st">&quot;anova&quot;</span>)) </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>        result &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(x)[<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&quot;Chisq&quot;</span>, <span class="st">&quot;Pr(&gt;Chisq)&quot;</span>)]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="kw">inherits</span>(x, <span class="st">&quot;htest&quot;</span>)) result &lt;-<span class="st"> </span><span class="kw">c</span>(x<span class="op">$</span>statistic, x<span class="op">$</span>p.value)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>    <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;stat&quot;</span>, <span class="st">&quot;p-value&quot;</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>    <span class="kw">round</span>(result, <span class="dv">3</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="bibliography" class="section level2 unnumbered">
<h2 class="unnumbered">Bibliography</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-BENA:BOLD:BRAD:93">
<p>Ben-Akiva, M., D. Bolduc, and M. Bradley. 1993. “Estimation of Travel Choice Models with Randomly Distributed Values of Time.” Papers 9303. Laval - Recherche en Energie. <a href="https://ideas.repec.org/p/fth/lavaen/9303.html">https://ideas.repec.org/p/fth/lavaen/9303.html</a>.</p>
</div>
<div id="ref-BHAT:95">
<p>Bhat, Chandra R. 1995. “A Heteroscedastic Extreme Value Model of Intercity Travel Mode Choice.” <em>Transportation Research Part B: Methodological</em> 29 (6): 471–83. <a href="https://doi.org/10.1016/0191-2615(95)00015-6">https://doi.org/10.1016/0191-2615(95)00015-6</a>.</p>
</div>
<div id="ref-FORI:KOPP:93">
<p>Forinash, C. V., and F. S. Koppleman. 1993. “Application and Interpretation of Nested Logit Models and Intercity Mode Choice.” <em>Transportation Record</em> 1413: 98–106.</p>
</div>
<div id="ref-KOPP:WEN:98">
<p>Koppelman, Franck S., and Chieh-Hua Wen. 1998. “Alternative Nested Logit Models: Structure, Properties and Estimation.” <em>Transportation Research B</em> 32 (5): 289–98.</p>
</div>
<div id="ref-KOPP:WEN:00">
<p>Koppelman, Frank S., and Chieh-Hua Wen. 2000. “The Paired Combinatorial Logit Model: Properties, Estimation and Application.” <em>Transportation Research Part B: Methodological</em> 34 (2): 75–89. <a href="https://doi.org/10.1016/S0191-2615(99)00012-0">https://doi.org/10.1016/S0191-2615(99)00012-0</a>.</p>
</div>
<div id="ref-MEIJ:ROUW:06">
<p>Meijer, Erik, and Jan Rouwendal. 2006. “Measuring Welfare Effects in Models with Random Coefficients.” <em>Journal of Applied Econometrics</em> 21 (2): 227–44. <a href="https://doi.org/10.1002/jae.841">https://doi.org/10.1002/jae.841</a>.</p>
</div>
<div id="ref-SWAI:LOUV:93">
<p>Swait, J., and J. Louviere. 1993. “The Role of the Scale Parameter in the Estimation and Use of Multinomial Logit Models.” <em>Journal of Marketing Research</em> 30.</p>
</div>
<div id="ref-ZEIL:CROIS:10">
<p>Zeileis, Achim, and Yves Croissant. 2010. “Extended Model Formulas in R: Multiple Parts and Multiple Responses.” <em>Journal of Statistical Software</em> 34 (1): 1–13. <a href="https://doi.org/10.18637/jss.v034.i01">https://doi.org/10.18637/jss.v034.i01</a>.</p>
</div>
<div id="ref-ZEIL:HOTH:02">
<p>Zeileis, Achim, and Torsten Hothorn. 2002. “Diagnostic Checking in Regression Relationships.” <em>R News</em> 2 (3): 7–10.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Used by <span class="citation">Ben-Akiva, Bolduc, and Bradley (1993)</span> and <span class="citation">Meijer and Rouwendal (2006)</span>.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Used in particular by <span class="citation">(Forinash and Koppleman 1993)</span>, <span class="citation">Bhat (1995)</span>, <span class="citation">Koppelman and Wen (1998)</span> and <span class="citation">Koppelman and Wen (2000)</span>.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>This kind of heteroscedasticity shouldn’t be confused with alternative heteroscedasticity (<span class="math inline">\(\sigma^2_j \neq \sigma^2_k\)</span>) which is introduced in the heteroskedastic logit model described in vignette <a href="./c4.relaxiid.html">relaxing the iid hypothesis</a><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>See <span class="citation">(Zeileis and Croissant 2010)</span> for a description of the <code>Formula</code> package.<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
